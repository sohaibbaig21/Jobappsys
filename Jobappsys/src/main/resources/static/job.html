<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Job Details | Jobappsys</title>
    <link rel="stylesheet" href="/styles.css">
    <script defer src="/js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
          $api.renderHeader('jobs');
          const container = document.getElementById('job-detail');
          const status = document.getElementById('status');

          // 1. Get ID from URL
          const jobId = $api.qs('id');
          if (!jobId) { status.textContent = 'No job ID provided.'; return; }

          status.textContent = 'Loading details...';

          try {
            // 2. Fetch Job Details
            const response = await $api.apiFetch(`/api/jobs/${jobId}`, { auth: false });
            const job = await response.json();
            status.textContent = '';

            // 3. Render Page
            const title = job.title || 'Untitled';
            const salary = job.salary ? `$${job.salary}` : 'N/A';
            const desc = job.description || 'No description.';
            const questions = job.questions || []; // Get questions

            container.innerHTML = `
              <div class="card stack">
                <h1>${title}</h1>
                <div class="row muted">
                   <span>üìç ${job.location || 'Remote'}</span>
                   <span>üíº ${job.employmentType || 'Full-time'}</span>
                   <span>üí∞ ${salary}</span>
                </div>
                <hr style="width:100%; border:0; border-top:1px solid #eee;">
                <h3>Description</h3>
                <p style="white-space: pre-wrap;">${desc}</p>

                <!-- Job Questions Section -->
                <div id="job-questions" class="stack" style="margin-top: 25px;">
                    ${questions.length > 0 ? '<h3>Questions</h3>' : ''}
                    ${questions.map(q => `
                        <div class="question-item" data-question-id="${q.id}" data-question-type="${q.questionType}" data-is-required="${q.isRequired}">
                            <label>${q.questionText} ${q.isRequired ? '<span style="color: red;">*</span>' : ''}</label>
                            ${q.questionType === 'TEXT' ? `<textarea rows="4" ${q.isRequired ? 'required' : ''}></textarea>` : ''}
                            ${q.questionType === 'SINGLE_CHOICE' && q.options ? `
                                ${q.options.map(option => `
                                    <div>
                                        <input type="radio" name="question-${q.id}" value="${option}" ${q.isRequired ? 'required' : ''}>
                                        <label>${option}</label>
                                    </div>
                                `).join('')}
                            ` : ''}
                            ${q.questionType === 'MULTI_CHOICE' && q.options ? `
                                ${q.options.map(option => `
                                    <div>
                                        <input type="checkbox" name="question-${q.id}" value="${option}">
                                        <label>${option}</label>
                                    </div>
                                `).join('')}
                            ` : ''}
                        </div>
                    `).join('')}
                </div>

                <div class="row" style="margin-top: 20px;">
                    <input type="file" id="resumeFile" accept=".pdf,.doc,.docx" style="margin-bottom: 10px;">
                    <button id="applyBtn" onclick="applyForJob(${job.id})">Apply Now</button>
                    <a href="/jobs.html" class="btn secondary">Back to Jobs</a>
                </div>
                <div id="apply-msg" class="muted" style="margin-top:10px;"></div>
              </div>
            `;
          } catch (e) {
            status.className = 'error';
            status.textContent = 'Error loading job: ' + (e.message || 'Job not found');
          }
        });

        // --- APPLY LOGIC ---
        async function applyForJob(id) {
            const msg = document.getElementById('apply-msg');
            const btn = document.getElementById('applyBtn');
            const questionContainer = document.getElementById('job-questions');
            const resumeFileInput = document.getElementById('resumeFile'); // Get the file input

            // 1. Check if user is logged in
            if (!$api.getAuth()) {
                // Redirect to login if not logged in
                window.location.href = `/login.html?next=/job.html?id=${id}`;
                return;
            }

            // 2. Collect Answers
            const answers = [];
            const questionElements = questionContainer.querySelectorAll('div[data-question-id]');

            for (const qEl of questionElements) {
                const questionId = qEl.dataset.questionId;
                const questionType = qEl.dataset.questionType;
                const isRequired = qEl.dataset.isRequired === 'true';
                let answerText = '';

                if (questionType === 'TEXT') {
                    const input = qEl.querySelector('textarea');
                    answerText = input ? input.value : '';
                } else if (questionType === 'SINGLE_CHOICE') {
                    const checkedRadio = qEl.querySelector('input[type="radio"]:checked');
                    answerText = checkedRadio ? checkedRadio.value : '';
                } else if (questionType === 'MULTI_CHOICE') {
                    const checkedCheckboxes = qEl.querySelectorAll('input[type="checkbox"]:checked');
                    answerText = Array.from(checkedCheckboxes).map(cb => cb.value).join(',');
                }

                if (isRequired && !answerText) {
                    msg.className = 'error';
                    msg.textContent = 'Please answer all required questions.';
                    btn.disabled = false;
                    btn.textContent = 'Apply Now';
                    return;
                }

                
                answers.push({
                    questionId: questionId, // Send as string, not parsed integer
                    answerText: answerText
                });
            }

            // 3. Disable button while processing
            btn.disabled = true;
            btn.textContent = 'Applying...';
            msg.className = 'muted';
            msg.textContent = '';

            try {
                const form = new FormData();
                form.append('applicationRequest', new Blob([JSON.stringify({ answers: answers })], { type: 'application/json' }));
                // Append resume file if selected
                if (resumeFileInput && resumeFileInput.files.length > 0) {
                    form.append('resumeFile', resumeFileInput.files[0]);
                }

                const response = await $api.apiFetch(`/api/applications/apply/${id}`, {
                    method: 'POST',
                    body: form,
                    auth: true // Requires authentication
                    // NOTE: Do NOT set Content-Type for FormData; browser sets it automatically
                });

                // If backend returns an error (e.g., 400/409/500), don't show success
                if (!response.ok) {
                    let errorMsg = '';
                    try {
                        // Try to read JSON error first
                        const data = await response.clone().json();
                        errorMsg = data.message || data.error || JSON.stringify(data);
                    } catch (_) {
                        try {
                            errorMsg = await response.text();
                        } catch (_) {
                            errorMsg = `Request failed (HTTP ${response.status})`;
                        }
                    }
                    throw new Error(errorMsg || `Request failed (HTTP ${response.status})`);
                }

                // 4. Success Message (only if response.ok)
                msg.className = 'success';
                msg.textContent = '‚úÖ Application Submitted Successfully!';
                btn.textContent = 'Applied';
            } catch (e) {
                // 5. Error Handling
                btn.disabled = false;
                btn.textContent = 'Apply Now';
                msg.className = 'error';

                // Show the specific error message from your Service (e.g., "Already applied")
                msg.textContent = '‚ùå ' + (e.message || 'Application failed');
            }
        }
    </script>
</head>
<body>
<main class="stack" style="max-width: 800px; margin: 0 auto;">
    <div id="status" class="muted"></div>
    <div id="job-detail"></div>
</main>
</body>
</html>